# RocketMQ消息发送
## 消息发送主要步骤
1. Producer从本地缓存获取消息路由信息。
2. 如果本地缓存没有路由信息，则从NameServer获取消息路由信息。
3. 发送消息到Broker。
4. Broker存储消息。

## 消息发送步骤
1. 消息基本校验
2. 消息设置topic
3. 校验Produce状态
4. 校验消息
5. 获取Topic路由信息，如果获取不到就从NameServer中获取
6. 获取配置的重试次数
7. 根据Topic路由信息获取一个要发送的消息队列，其中涉及到故障延迟机制
8. 实际发送消息
9. 发送完消息后更新FaultItem，这也是用在故障延迟机制中的
10. 查看发送结果，如果需要重试，就进行重试。
11. 处理异常。
### 实际消息发送中的过程
1. 根据BrokerName获取Broker主地址
2. 获取不到的话，就尝试更新Topic路由信息，再次获取Broker主地址
3. 设置消息msgId
4. 设置InstanceId
5. 超过4k的消息需要压缩
6. 设置压缩标记和事务消息的标记
7. 前置检查钩子函数
8. 发送前钩子函数
9. 组装发送信息
10. 发送
11. 后置钩子
12. 处理异常
13. 恢复消息为未压缩前的

## 消息队列负载机制
消息生产者在发送消息时，如果本地路由表中未缓存Topic的路由信息，就向NameServer发送获取路由信息的请求，更新路由表信息，并且消息生产者每隔30秒从NameServer更新路由表。
## 消息发送异常机制
消息发送高可用主要有两个手段：

1. 重试
2. 规避，规避就是在一次消息发送过程中如果出现错误，在某一段时间内消息生产者不会选择该Broker上的消息队列，提高发送消息的成功率。