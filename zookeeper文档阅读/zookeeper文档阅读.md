# Zookeeper简介

zookeeper存储类似于标准文件系统。命名空间包括：数据寄存器znodes，和文件、目录一样。

zookeeper优点：

- 高性能，zookeeper数据保存在内存中，可以实现高吞吐量和低延迟的数据。
- 高可用，zookeeper集群可以防止单点故障。
- 严格的访问顺序，可以在客户端实现复杂的同步原件。

zookeeper功能简介：

- 复制，zookeeper自己在处理协调的时候要复制多个主机。服务组成部分必须要彼此知道彼此，维持了一个内存状态影像，连同事务日志和快照在一个持久化的存储中，只要大多数服务器是可用，就是可用的。
- 客户端连接到一个单独的服务，客户端保持了一个TCP连接，通过这个TCP连接发送请求、获取响应、获取watch事件、发送心跳，如果连接断了，会自动连接到其他不同的服务器。
- 序列，zookeeper用数字标记每一个更新，可以用来反映出所有的事务顺序，后面的操作可以使用这个顺序去实现更高级的抽象，比如同步组件。
- 快速，在读多写少的情况下运行最好。

## 数据模型和分层命名空间

zookeeper的命名空间很像一个标准的文件系统，一个名字是以一系列的以`/`隔开的路径元素，命名空间中的所有节点都是通过路径识别。

## 节点和临时节点

zookeeper命名空间中的每个节点可以有数据也可以有子目录。

临时节点和session存活时间一样长，session结束时临时节点也会被删除。

## 条件的更新和watches

客户端可以在znode上设置一个watch，当znode发生变化时触发并移除watch，当watch被触发时，客户端会接收到一个包说明znode有变化了。

## 保证

zookeeper提供了一套保证：

- 顺序一致性，来自客户端的更新会按顺序引用。
- 原子性，更新成功或失败，没有局部的结果产生。
- 唯一系统影像，一个客户端不管连接到哪个服务器端，都会看到同样的视图。
- 可靠性，一旦一个更新被应用，他将从更新的时间开始一直保持到一个客户端重写更新。
- 时效性，系统中的客户端视图在特定时间保证成为时最新的。

## 简单API

支持的操作：

- create，在树形结构的位置中创建节点。
- delete，删除一个节点。
- exists，测试节点在指定位置上是否存在。
- get data，从节点上读取数据。
- set data，往节点上写入数据。
- get children，检索一个节点的子节点列表。
- sync，等待传输数据。

# zookeeper开发者编程指南

## zookeeper数据模型

zookeeper有一个分层的命名空间，像一个分布式的文件系统，不同地方仅仅是命名空间里的每个节点可以有关联数据也可以有子目录。

路径节点总是表示为标准的，绝对的，以斜线为分隔符的路径，没有相对引用，任何Unicode编码字符都可以用在路径上，但是有以下限制：

- null字符（`\u0000`）不能作为路径名字的一部分，会导致C绑定的问题。
- `\u0001` - `\u0019`和`\u007F` - `\u009F`不能使用，显示不好或者显示混乱。
- `\ud800` -`uF8FFF`, `\uFFF0`-`uFFFF`,` \uXFFFE `- `\uXFFFF` (其中X是一个数字：1-E), `\uF0000` - `\uFFFFF`不能使用。
- ·.·可以作为名字的一部分，但是`.`和`..`不能单独使用，zookeeper不使用相对路径。
- zookeeper是预留的。

## znodes

每个节点成为znode，znode维护了一个stat结构，包含数据变化的版本号、访问控制列表变化、时间戳。每次znode数据变化，版本号就增加。

### watches

客户端可以在znode上设置watches，znode的变化会触发watches后清除watches，触发watches后会向客户端发送一个通知。

### 数据访问

命名空间里的每个znodes上的数据存储都是原子性的读取和写入。读取时获取所有与znode有关的数据字节，写入时替换所有的数据字节。每个节点都有一个访问控制列表用来限制谁可以做什么。

### 临时节点

zookeeper的临时节点，session创建的时候存在，session结束就被删除，临时节点不允许有子节点。

### 序列节点

创建znode的时候还可以请求在路径的最后追加一个单调递增的计数器，这个计数器在父节点时唯一的。

## zookeeper里的计时

### zxid

每个zookeeper状态的变化都以zxid（事务id）的形式接收到标记，这个暴露了zookeeper所有变化的总排序。每个变化都会有一个zxid，并且如果zxid1早于zxid2，则1一定小于2。

### 版本号

节点的每个变化都会引起那个节点的版本号的其中之一的增加，三个版本号是：

- version，znode的数据变化版本号。
- cversion，子目录的变化版本号。
- aversion，访问控制列表的变化版本号。

### ticks

使用多服务器的zookeeper时，服务器使用ticks定义事件的时间，如状态上传、会话超时、同事之间的连接超时等。

### real time

zookeeper不使用实时或者时钟时间，除了将时间戳加在znode创建和更新的stat结构上。

## Stat结构

stat结构字段：

- czxid，引起这个znode创建的zxid。
- mzxid，znode最后更新的zxid。
- ctime，znode被创建的毫秒数，从1970开始。
- mtime，znode最后被修改的毫秒数，从1970开始。
- version，znode数据变化版本号。
- cversion，znode子节点变化版本号。
- aversion，znode访问控制列表的变化版本号。
- ephemeralOwner，如果是临时节点，这个是znode拥有者的session id，如果不是临时节点，则是0。
- dataLength，znode的数据长度。
- numChildren，znode子节点数量。

